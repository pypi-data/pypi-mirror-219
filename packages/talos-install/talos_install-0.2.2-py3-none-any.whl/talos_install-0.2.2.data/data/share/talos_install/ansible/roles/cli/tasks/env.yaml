---
- name: Ensure bash-completion dir exist
  ansible.builtin.file:
    path: "{{ master.home }}/.bash_completion.d"
    state: directory
    mode: '0770'
    owner: "{{ master.user }}"
    group: "{{ master.group }}"

- name: Create talos directories
  ansible.builtin.file:
    path: "{{ master.home }}/.talos"
    state: directory
    mode: '0770'
    owner: "{{ master.user }}"
    group: "{{ master.group }}"

- name: Copy env_talos templates
  ansible.builtin.template:
    src: "env_talos.j2"
    dest: "{{ master.home }}/.talos/env"
    mode: '0770'
    owner: "{{ master.user }}"
    group: "{{ master.group }}"

- name: "Ensure master.user env is sourced from the .bashrc"
  ansible.builtin.blockinfile:
    dest: "{{ master.home }}/.bashrc"
    block: |
      export PATH=$PATH:{{ app.clidir }}
      source {{ master.home }}/.talos/env
      if [[ -d ~/.bash_completion.d/ ]] && ! find ~/.bash_completion.d/. ! -name . -prune -exec false {} +
      then
        for f in ~/.bash_completion.d/*
        do
          source "$f"
        done
      fi
      BCyan="\[\033[1;36m\]"        # Cyan
      BWhite="\[\033[1;37m\]"       # White
      BGreen="\[\033[1;32m\]"       # Green
      BYellow="\[\033[1;33m\]"      # Yellow
      Color_Off="\[\033[0m\]"       # Text Reset
      export PS1="\r[${BYellow}{{ customer.domain }}${BWhite}|${BCyan}TALOS-CLI${BWhite}] \h | \w ${Color_Off}\n# "
    marker: '# {mark} ANSIBLE MANAGED BLOCK - talos'
    insertbefore: BOF
    create: true
    mode: '0644'
