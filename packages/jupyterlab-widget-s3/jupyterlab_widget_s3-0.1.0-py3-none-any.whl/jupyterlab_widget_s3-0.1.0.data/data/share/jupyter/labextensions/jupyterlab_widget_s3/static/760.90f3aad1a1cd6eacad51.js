"use strict";(self.webpackChunkjupyterlab_widget_s3=self.webpackChunkjupyterlab_widget_s3||[]).push([[760],{4224:(e,t,n)=>{n.r(t),n.d(t,{default:()=>I});var s,o=n(7638),r=n(8299),i=n(931),a=n(122),c=n(1840),l=n(344),d=n(5139),u=n(4022);class p{constructor(e){this._isDisposed=!1,this._fileChanged=new c.Signal(this),this._registry=e}get name(){return"S3"}get fileChanged(){return this._fileChanged}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,c.Signal.clearData(this))}get(e,t){return this.pathToJupyterContents(e)}getDownloadUrl(e){return console.log("not yet implemented"),Promise.reject("Not yet implemented")}newUntitled(e={}){return Promise.reject("Not yet implemented")}delete(e){return Promise.reject("Not yet implemented")}rename(e,t){return Promise.reject("Not yet implemented")}save(e,t){return Promise.reject("Not yet implemented")}copy(e,t){return Promise.reject("Not yet implemented")}createCheckpoint(e){return Promise.reject("Not yet implemented")}listCheckpoints(e){return Promise.resolve([])}restoreCheckpoint(e,t){return Promise.reject("Not yet implemented")}deleteCheckpoint(e,t){return Promise.reject("Read only")}jupyterPathToS3Path(e,t){return""===e?e="/":t&&(e+="/"),e}s3ToJupyterContents(e){return{name:e.name,path:e.path,format:"json",type:e.type,created:"",writable:!1,last_modified:"",mimetype:e.mimetype,content:e.content}}pathToJupyterContents(e){let t;return e!==s.currentPath&&"file"!==s.availableContentTypes[e]&&(s.showingError&&s.hideErrorMessage(),s.showDirectoryLoadingSpinner()),"file"!==s.availableContentTypes[e]?(s.currentPath=e,t=this.jupyterPathToS3Path(e,!0)):t=this.jupyterPathToS3Path(e,!1),new Promise(((n,o)=>{const r=d.ServerConnection.makeSettings();d.ServerConnection.makeRequest(l.URLExt.join(r.baseUrl,"jupyterlab_widget_s3/files",t),{},r).then((t=>{t.json().then((t=>{if(t.error){const e=`Server returned status code ${t.error}. Error message: ${t.message}.`;return console.error(e),s.showErrorMessage(e),o(e),[]}if(Array.isArray(t))s.hideDirectoryLoadingSpinner(),t.forEach((e=>{s.availableContentTypes[e.path]=e.type})),n({type:"directory",path:e.trim(),name:"",format:"json",content:t.map((e=>this.s3ToJupyterContents(e))),created:"",writable:!1,last_modified:"",mimetype:""});else{const o=this._registry.getFileTypesForPath(e),r=0===o.length?this._registry.getFileType("text"):o[0],i=r.mimeTypes[0],a=r.fileFormat;let c;switch(a){case"text":c=s.b64DecodeUTF8(t.content);break;case"base64":c=t.content;break;case"json":c=JSON.parse(s.b64DecodeUTF8(t.content));break;default:throw new Error(`Unexpected file format: ${r.fileFormat}`)}n({type:"file",path:e,name:"",format:a,content:c,created:"",writable:!1,last_modified:"",mimetype:i})}})).then((e=>(""===s.currentPath?document.querySelector("#s3-filebrowser").classList.add("root"):document.querySelector("#s3-filebrowser").classList.remove("root"),e)))}))}))}}!function(e){const t=new TextDecoder("utf8");e.b64DecodeUTF8=function(e){const n=u.toByteArray(e.replace(/\n/g,""));return t.decode(n)},e.availableContentTypes={},e.showingError=!1,e.showErrorMessage=function(t){e.hideDirectoryLoadingSpinner();const n=document.querySelector("#s3-filebrowser > .jp-DirListing");n&&(n.insertAdjacentHTML("afterend",`<div class="s3-error"><p>${t}</p></div>`),n.style.display="none",e.showingError=!0)},e.hideErrorMessage=function(){document.querySelector("#s3-filebrowser > .jp-DirListing").style.display="block",document.querySelector(".s3-error")&&document.querySelector(".s3-error").remove(),e.showingError=!1},e.showDirectoryLoadingSpinner=function(){if(document.querySelector("#s3-spinner"))return;document.querySelector("#s3-filebrowser").classList.add("loading");const e=document.querySelector("#s3-filebrowser .jp-DirListing-content"),t=document.createElement("div");t.classList.add("jp-SpinnerContent"),t.id="s3-spinner",e.appendChild(t)},e.hideDirectoryLoadingSpinner=function(){const e=document.querySelector("#s3-spinner");if(document.querySelector("#s3-filebrowser").classList.remove("loading"),e)try{e.remove()}catch(e){console.error(e)}}}(s||(s={}));var m=n(8832),h=n(6303),f=n(7969),y=n.n(f),v=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{ref:"authForm",staticClass:"auth-form"},[t("h4",[e._v("S3 Object Storage Browser")]),e._v(" "),t("div",{staticClass:"desc"},[e._v("\n    This extension allows you to browse S3-compatible object storage\n    instances, such as AWS S3 and IBM Cloud Object Storage.\n  ")]),e._v(" "),t("br"),e._v(" "),t("div",{staticClass:"form-item"},[t("label",[e._v("Endpoint URL")]),e._v(" "),t("select",{directives:[{name:"model",rawName:"v-model",value:e.form.endpoint_idx,expression:"form.endpoint_idx"}],attrs:{name:"endpoint_idx"},on:{change:[function(t){var n=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){return"_value"in e?e._value:e.value}));e.$set(e.form,"endpoint_idx",t.target.multiple?n:n[0])},e.changeEndPoint]}},e._l(e.s3Configs,(function(n,s){return t("option",{key:s,domProps:{value:s}},[e._v("\n        "+e._s(n.endpoint)+"\n      ")])})),0)]),e._v(" "),t("div",{staticClass:"form-item"},[t("label",[e._v("Access Key ID")]),e._v(" "),t("input",{directives:[{name:"model",rawName:"v-model",value:e.form.client_id,expression:"form.client_id"}],attrs:{type:"password",name:"client_id"},domProps:{value:e.form.client_id},on:{input:function(t){t.target.composing||e.$set(e.form,"client_id",t.target.value)}}})]),e._v(" "),t("div",{staticClass:"form-item"},[t("label",[e._v("Secret Access Key")]),e._v(" "),t("input",{directives:[{name:"model",rawName:"v-model",value:e.form.client_secret,expression:"form.client_secret"}],attrs:{type:"password",name:"client_secret"},domProps:{value:e.form.client_secret},on:{input:function(t){t.target.composing||e.$set(e.form,"client_secret",t.target.value)}}})]),e._v(" "),t("div",{staticClass:"form-item"},[t("label",[e._v("(Optional) Session Token")]),e._v(" "),t("input",{directives:[{name:"model",rawName:"v-model",value:e.form.session_token,expression:"form.session_token"}],attrs:{type:"password",name:"session_token"},domProps:{value:e.form.session_token},on:{input:function(t){t.target.composing||e.$set(e.form,"session_token",t.target.value)}}})]),e._v(" "),t("div",{staticClass:"submit",on:{click:e.connect}},[e._v("Connect")])])};v._withStripped=!0;var g=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"footer"},[t("a-button",{attrs:{type:e.type},on:{click:function(t){return e.$emit("oneBtnClick")}}},[e._v(e._s(e.text))])],1)};g._withStripped=!0;const _=y().extend({props:["text","type"]});var b=n(1900);const S=(0,b.Z)(_,g,[],!1,null,null,null).exports,w=new WeakMap;var j=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("pre",{class:e.cls,domProps:{innerHTML:e._s(e.html)}})};j._withStripped=!0;const C=y().extend({props:["html","cls"]}),k=(0,b.Z)(C,j,[],!1,null,null,null).exports;var x=function(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};class T{static _parse(e){if("object"!=typeof e)return e;const t=[];return Object.keys(e).forEach((n=>{let s=e[n];Array.isArray(s)&&(s=s.join(",")),t.push(`${n}=${s}`)})),t.join("&")}static makePostRequest(e,t,n=!1,s={"Content-Type":"application/json;charset=utf-8"}){var o;return x(this,void 0,void 0,(function*(){return n&&s["Content-Type"]&&delete s["Content-Type"],(null===(o=s["Content-Type"])||void 0===o?void 0:o.indexOf("json"))>0&&"object"==typeof t&&(t=JSON.stringify(t)),this.makeServerRequest(e,{method:"POST",headers:s,body:t})}))}static makePutRequest(e,t,n=!1,s={"Content-Type":"application/json;charset=utf-8"}){var o;return x(this,void 0,void 0,(function*(){return n&&s["Content-Type"]&&delete s["Content-Type"],(null===(o=s["Content-Type"])||void 0===o?void 0:o.indexOf("json"))>0&&"object"==typeof t&&(t=JSON.stringify(t)),this.makeServerRequest(e,{method:"PUT",headers:s,body:t})}))}static makeGetRequest(e,t){return x(this,void 0,void 0,(function*(){return t&&e.indexOf("?")<0&&(e+=`?${this._parse(t)}`),this.makeServerRequest(e,{method:"GET"})}))}static makeDeleteRequest(e,t){return x(this,void 0,void 0,(function*(){return t&&e.indexOf("?")<0&&(e+=`?${this._parse(t)}`),this.makeServerRequest(e,{method:"DELETE"})}))}static makeServerRequest(e,t,n){var s;return x(this,void 0,void 0,(function*(){const o="https://jupyter.js.sgcc.com.cn",r=d.ServerConnection.makeSettings(Object.assign({baseUrl:o.indexOf("http")>-1?o:`http://${o}`},n||{})),i=l.URLExt.join(r.baseUrl,`${null!==(s="/jub")?s:""}${e}`),a={mode:"cors"};Object.assign(a,{credentials:"include"});const c=Object.assign(t,a),{type:u="json"}=c,p=function(e,t){var n={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(n[s[o]]=e[s[o]])}return n}(c,["type"]);return console.log(`Sending a ${p.method} request to ${i}`),new Promise(((t,n)=>{d.ServerConnection.makeRequest(i,p,r).then((s=>{s[u]().then((e=>{if(405!==s.status)return s.status<200||s.status>=300?n(e):void t(e);t(null)}),(o=>404===s.status||409===s.status?(s.requestPath=e,n(s)):204!==s.status?n(o):void t({})))}),(e=>n(e)))})).then((e=>"0"===e.code||"200"===e.status?e.data:void 0!==e.code?Promise.reject({message:P(i,p,e)}):e)).catch((e=>{const t=e.message||e.traceback||e.reason||"系统繁忙，请稍后再重试。";return function(e,t={},{visible:n=!0,title:s="",hasFooter:o=!0,okText:r="确认",cancelText:i="取消",width:a=800,wrapClassName:c="",destroyOnClose:l=!1,oneBtnText:d="",oneBtnType:u="",ok:p,cancel:m,scopedSlots:h={}}={}){let f=null,v=w.get(e);if(v)return g(!0),null;function g(e){v.visible=e}f=document.createElement("div"),f.id="js-create-modal",v=new(y())({data:{visible:n}}),w.set(e,v),new(y())({render:n=>n(y().component("AModal"),{attrs:{class:"ant-modal-root dfc-widgets-vue"},props:Object.assign({visible:v.visible,wrapClassName:c,title:s,okText:r,cancelText:i,width:a,destroyOnClose:l},o?{}:{footer:!1}),on:{ok:function(e){null==p||p(e),g(!1)},cancel:function(e){null==m||m(e),g(!1)}},scopedSlots:Object.assign(Object.assign(Object.assign({},h),e?{default:s=>n(e,{props:Object.assign(Object.assign(Object.assign({},s),t||{}),{setVisible:g})})}:{}),d&&o?{footer:e=>n(S,{props:Object.assign(Object.assign({},e),{text:d,type:u}),on:{oneBtnClick:function(e){g(!1)}}})}:{})})}).$mount(f)}(k,{html:t},{wrapClassName:"request-error-modal",width:700,title:"请求失败",oneBtnText:"关闭",oneBtnType:"primary"}),Promise.reject(e)}))}))}}function P(e,t,n){const{method:s}=t;return`<div>请求地址：${e}<br/>请求方式：${s}<br/>失败原因：${(n.msg||n.message).replace(/\\n/g,"\r\n")||"未知"}</div>`}function O(){return T.makeGetRequest("/resource/queryStorageResource")}const E=new WeakMap;class D{static openSpin({delay:e=0,indicator:t=null,size:n="default",tip:s="",wrapperClassName:o="",parent:r=document.body,timeout:i=6e4}={}){if(E.get(r))this._setVisible(!0,r);else{const i=this._createSpin({delay:e,indicator:t,size:n,tip:s,wrapperClassName:o,parent:r});E.set(r,i)}0!==i&&setTimeout((()=>{this.closeSpin(r)}),i)}static closeSpin(e=document.body){this._setVisible(!1,e)}static setSpinProps({spinning:e=!0,tip:t=""}={},n=document.body){this._setVisible(e,n);const{spinDepVM:s}=E.get(n);s.tip=t}static _setVisible(e,t){const{spinDepEL:n,spinDepVM:s}=E.get(t);s.spinning=e,n.style.display=e?"block":"none"}static _createSpin({delay:e,indicator:t,size:n,tip:s,wrapperClassName:o,parent:r}){const i=new(y())({data:{spinning:!0,tip:s}}),a=document.createElement("div");a.id="jls-create-spin",a.style.cssText="position:absolute;left:0;right:0;top:0;bottom:0;z-index:99999999";const c=document.createElement("div");c.style.cssText="position:absolute;left:0;right:0;top:0;bottom:0;";const l=document.createElement("div");return a.appendChild(c),a.appendChild(l),r.style.position="relative",r.appendChild(a),new(y())({render:r=>r(y().component("ASpin"),{attrs:{style:"position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);"},props:{spinning:i.spinning,delay:e,size:n,tip:s,wrapperClassName:`dfc-widgets-vue ${o}`},scopedSlots:Object.assign({},t?{indicator:()=>r(t.component,{props:t.props})}:{})})}).$mount(l),{spinDepEL:a,spinDepVM:i}}}const q=y().extend({props:["onSubmit"],data:()=>({form:{endpoint_idx:0,endpoint_url:"",client_id:"",client_secret:"",session_token:""},s3Configs:[]}),methods:{changeEndPoint(e){const t=e.target.value,{endpoint:n,accessKey:s,secretKey:o}=this.s3Configs[t];this.form={session_token:this.form.session_token,client_secret:o,endpoint_url:n,client_id:s,endpoint_idx:t}},connect(){const{endpoint_url:e,client_id:t,client_secret:n,session_token:s}=this.form,o=this.$refs.authForm;D.openSpin({parent:o,timeout:0}),this.onSubmit({endpoint_url:e,client_id:t,client_secret:n,session_token:s}).then((()=>{D.closeSpin(o)}))}},mounted(){const e=this.$refs.authForm;D.openSpin({parent:e}),O().then((t=>{this.s3Configs=t;const{endpoint:n,accessKey:s,secretKey:o}=t[0];this.form={client_secret:o,endpoint_url:n,client_id:s,session_token:"",endpoint_idx:0},D.closeSpin(e)}))}}),$=(0,b.Z)(q,v,[],!1,null,null,null).exports;var L=n(287),N=n(5973),R=n(7762),A=n(3147);let F;class U extends m.Widget{constructor(e,t,n){super(),this.addClass("jp-S3Browser"),this.layout=new m.PanelLayout;const s=t=>{console.log(t,"formData");const n=d.ServerConnection.makeSettings();return d.ServerConnection.makeRequest(l.URLExt.join(n.baseUrl,"jupyterlab_widget_s3/auth"),{method:"POST",body:JSON.stringify(t)},n).then((t=>{t.json().then((t=>{if(t.success)this.layout.removeWidget(F),this.layout.addWidget(e),e.model.refresh();else{let e=t.message;e.includes("InvalidAccessKeyId")?e="The access key ID you entered was invalid.":e.includes("SignatureDoesNotMatch")&&(e="The secret access key you entered was invalid"),(0,h.showErrorMessage)("S3 Authentication Error",Error(e))}}))}))};M.checkIfAuthenicated().then((t=>{t?(this.layout.addWidget(e),setTimeout((()=>{e.model.refresh()}),1e3)):(F=new m.Widget({node:M.createS3AuthenticationForm(s)}),this.layout.addWidget(F))}))}}var M;!function(e){e.createS3AuthenticationForm=function(e){var t;(t=y()).use(L.Z),t.use(N.default),t.use(R.ZP),t.use(A.default);const n=new(y())({render:t=>t($,{props:{onSubmit:e}})});return n.$mount(document.createElement("div")),n.$el.id="jupyterlab-s3-browser",n.$el},e.checkIfAuthenicated=function(){return new Promise(((e,t)=>{const n=d.ServerConnection.makeSettings();d.ServerConnection.makeRequest(l.URLExt.join(n.baseUrl,"jupyterlab_widget_s3/auth"),{method:"GET"},n).then((t=>{t.json().then((t=>{e(t.authenticated)}))}))}))}}(M||(M={}));const B="s3-filebrowser",I={id:"jupyterlab_widget_s3:drive",requires:[i.IDocumentManager,a.IFileBrowserFactory,o.ILayoutRestorer,r.ISettingRegistry],activate:function(e,t,n,s,o){const r=new p(e.docRegistry);t.services.contents.addDrive(r);const i=n.createFileBrowser(B,{driveName:r.name,state:null,refreshInterval:3e5}),a=new U(i,r,t);return a.title.iconClass="jp-S3-icon jp-SideBar-tabIcon",a.title.caption="Object Storage Browser",a.id="s3-file-browser",s.add(a,B),void e.shell.add(a,"left",{rank:100})},autoStart:!0}}}]);